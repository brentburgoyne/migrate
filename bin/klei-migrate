#!/usr/bin/env node

/**
 * This is a SUPER-WORK-IN-PROGRESS...
 * Almost not ready at all, but soon.
 */
var clc = require('cli-color');

var info = clc.blackBright,
    error = clc.red,
    ok = clc.green,
    commands = clc.greenBright,
    switches = clc.blueBright;

var args = process.argv.slice(2),
    migrate = require('../.');

switch (args.shift()) {
    case 'new':
    case 'create':
        migrate.create(args.join(' '), function (err, name) {
            if (err) {
                console.error(err);
            } else {
                console.log(ok('Migration: "' + name + '" created!'));
            }
        });
        break;
    case 'run':
        var direction = args.indexOf('--up') >= 0 || args.indexOf('--down') == -1 ? 'up' : 'down',
            one = args.indexOf('--one') >= 0,
            dry = args.indexOf('--status') >= 0,
            name = args.pop();

        if (name && name.indexOf('-') === 0) {
            name = null;
        }

        migrate.direction(direction);

        if (one) {
            migrate.limit(1);
        }

        if (dry) {
            migrate.dry(name, function (migratable) {
                console.log(info('Migrating' + " " + migrate.direction() + ":"));
                console.log(info(migratable));
            });
        } else {
            migrate.run(name, function (err, migrated) {
                if (migrated.length) {
                    console.log(info('Migrated:', migrated));
                }
                if (err) {
                    console.error(error('Run failed!'));
                    console.error(info(err.stack));
                    process.exit(1);
                } else {
                    console.log(ok('All migrations run.'));
                }
            });
        }
        break;
    default:
        console.log("Usage: klei-migrate " + commands("<command>") + " " + switches("[swithces]") );
        console.log();
        console.log("   " + commands("new") + " " + "<migration name>");
        console.log();  
        console.log("   " + commands("run") + " " + switches("[switches]"));
        console.log("       " + switches("--up"))
        console.log("       " + switches("--down"))
        console.log("       " + switches("--one") + "    " +info("Run only one migration up/down"));
        console.log("       " + switches("--status") + "    " + info("Lists what is going to be migrated"));
        console.log();
        break;

}
